## Epic 1: Infrastructure & Project Setup

### User Story 1.1: Инициализация репозитория и структуры проекта
* **Описание:** Инициализировать Git-репозиторий и выстроить папки по Clean Architecture.
* **Критерии приёмки:**
  * Репозиторий инициализирован.
  * Структура каталогов соответствует договорённостям.
  
#### Tasks
- **Task 1.1.1:** Инициализировать Git-репозиторий.  
  *Приоритет: High • Оценка: 1 SP • Статус: Done*  
- **Task 1.1.2:** Создать базовую структуру каталогов (entities, usecases, gateways, web).  
  *Приоритет: High • Оценка: 2 SP • Статус: Done*

### User Story 1.2: Конфигурация зависимостей
* **Описание:** Настроить Poetry для управления зависимостями и скрипты запуска.
* **Критерии приёмки:**
  * Файл `pyproject.toml` с основными библиотеками.
  * Скрипты `start`, `test` в разделе `tool.poetry.scripts`.
  
#### Tasks
- **Task 1.2.1:** Добавить зависимости FastAPI, SQLAlchemy, Pydantic, aiogram.  
  *Приоритет: High • Оценка: 2 SP • Статус: Done*  
- **Task 1.2.2:** Настроить скрипты запуска и тестирования.  
  *Приоритет: Medium • Оценка: 1 SP • Статус: Done*

### User Story 1.3: Docker и окружение
* **Описание:** Поднять контейнеры для Postgres и приложения через Docker Compose.
* **Критерии приёмки:**
  * Есть `docker-compose.yml` с сервисами `db` и `app`.
  * Контейнеры поднимаются и видят друг друга.

#### Tasks
- **Task 1.3.1:** Создать `docker-compose.yml` для Postgres и FastAPI.  
  *Приоритет: High • Оценка: 3 SP • Статус: Done*  
- **Task 1.3.2:** Документировать запуск и переменные окружения.  
  *Приоритет: Medium • Оценка: 2 SP • Статус: To Do*

### User Story 1.4: Инструменты качества кода
* **Описание:** Настроить pre-commit hooks для линтинга и форматирования.
* **Критерии приёмки:**
  * `.pre-commit-config.yaml` с flake8, black, isort.
  * Хуки автоматически применяются при `git commit`.

#### Tasks
- **Task 1.4.1:** Добавить flake8, black, isort в pre-commit.  
  *Приоритет: Medium • Оценка: 1 SP • Статус: Done*  
- **Task 1.4.2:** Прописать правила и исключения.  
  *Приоритет: Low • Оценка: 1 SP • Статус: To Do*

### User Story 1.5: Настройка CI/CD
* **Описание:** Автоматизировать тесты и деплой на staging-сервер.
* **Критерии приёмки:**
  * При пуше в `main` запускаются тесты.
  * После успешных тестов — деплой на staging.

#### Tasks
- **Task 1.5.1:** Настроить GitLab CI (`.gitlab-ci.yml`).  
  *Приоритет: High • Оценка: 3 SP • Статус: Done*  
- **Task 1.5.2:** Настроить автоматический деплой на staging.  
  *Приоритет: Medium • Оценка: 3 SP • Статус: To Do*

---

## Epic 2: Основной функционал признаний

### User Story 2.1: Создание нового признания
* **Описание:** Анонимный пользователь пишет и отправляет текст признания.
* **Критерии приёмки:**
  * Текстовое поле и кнопка «Отправить».
  * После отправки статус «На модерации».

#### Tasks
- **Task 2.1.1:** UI-форма для создания признания.  
  *High • 3 SP • To Do*  
- **Task 2.1.2:** API-эндпоинт `POST /api/confessions/`.  
  *High • 5 SP • To Do*  
- **Task 2.1.3:** Сохранение в БД через SQLAlchemy.  
  *High • 5 SP • To Do (depends on 2.1.2)*

### User Story 2.2: Модерация признаний
* **Описание:** Модератор просматривает и одобряет или отклоняет.
* **Критерии приёмки:**
  * Список «На модерации» с кнопками «Одобрить»/«Отклонить».
  * Возможность указать причину отказа.

#### Tasks
- **Task 2.2.1:** UI-страница модератора.  
  *High • 8 SP • To Do*  
- **Task 2.2.2:** API `/api/confessions/{id}/moderate`.  
  *High • 5 SP • To Do (depends on 2.1.2)*  
- **Task 2.2.3:** Логирование действий модератора.  
  *Medium • 3 SP • To Do*

### User Story 2.3: Публикация одобренных признаний
* **Описание:** Одобренные отправляются в Telegram-канал.
* **Критерии приёмки:**
  * Сообщение публикуется, статус меняется на «Опубликовано».
  * Сохраняется ссылка на пост.

#### Tasks
- **Task 2.3.1:** Интеграция с Telegram API.  
  *High • 8 SP • To Do*  
- **Task 2.3.2:** Фоновая задача для отправки (Celery/BackgroundTasks).  
  *High • 5 SP • To Do*

---

## Epic 3: Взаимодействие с пользователями

### User Story 3.1: Просмотр опубликованных признаний
* **Описание:** Лента одобренных признаний с пагинацией.
* **Критерии приёмки:**
  * Страница со списком, пагинация работает.

#### Tasks
- **Task 3.1.1:** UI-лента признаний.  
  *High • 5 SP • To Do*  
- **Task 3.1.2:** API `GET /api/confessions/?status=APPROVED`.  
  *High • 3 SP • To Do*

### User Story 3.2: Реакции на признания
* **Описание:** Лайки и сердечки под постами.
* **Критерии приёмки:**
  * Отображение счетчиков и кнопок выбора.
  * Обновление в реальном времени.

#### Tasks
- **Task 3.2.1:** UI-кнопки реакций.  
  *Medium • 3 SP • To Do*  
- **Task 3.2.2:** API `/api/confessions/{id}/reactions`.  
  *Medium • 5 SP • To Do*  
- **Task 3.2.3:** Хранение реакций в БД.  
  *Medium • 3 SP • To Do*

### User Story 3.3: Комментарии к признаниям
* **Описание:** Анонимные комментарии с древовидной структурой.
* **Критерии приёмки:**
  * Форма под постом, список комментариев, ответы.

#### Tasks
- **Task 3.3.1:** UI-комментарии.  
  *Medium • 5 SP • To Do*  
- **Task 3.3.2:** API `/api/confessions/{id}/comments`.  
  *Medium • 5 SP • To Do*  
- **Task 3.3.3:** Ветки комментариев (`parent_id`).  
  *Low • 3 SP • To Do*

---

## Epic 4: Расширенный функционал и улучшения

### User Story 4.1: Прикрепление медиафайлов
* **Описание:** Загрузка изображений и видео к признаниям.
* **Критерии приёмки:**
  * Кнопка «Прикрепить файл», поддержка JPG/PNG/GIF/MP4.
  * Отображение медиа вместе с текстом.

#### Tasks
- **Task 4.1.1:** UI-загрузка файлов.  
  *Medium • 2 SP • To Do*  
- **Task 4.1.2:** API для сохранения файлов (S3/локально).  
  *High • 8 SP • To Do*  
- **Task 4.1.3:** Валидация размера и типа.  
  *Medium • 3 SP • To Do*

### User Story 4.2: Опросы к признаниям
* **Описание:** Создание и голосование в опросах.
* **Критерии приёмки:**
  * Поля для вопроса/вариантов, голосование, отображение результатов.

#### Tasks
- **Task 4.2.1:** UI для создания опроса.  
  *Medium • 3 SP • To Do*  
- **Task 4.2.2:** API `/api/polls/`, `/api/polls/{id}/vote`.  
  *Medium • 5 SP • To Do*  
- **Task 4.2.3:** Отображение результатов.  
  *Medium • 3 SP • To Do*

### User Story 4.3: Поиск по признаниям
* **Описание:** Поиск по ключевым словам и тегам.
* **Критерии приёмки:**
  * Поле поиска, релевантные результаты, поиск по тегам.

#### Tasks
- **Task 4.3.1:** UI-поиск.  
  *Low • 3 SP • To Do*  
- **Task 4.3.2:** Поисковый движок (Elasticsearch/Postgres).  
  *Medium • 8 SP • To Do*  
- **Task 4.3.3:** API `/api/search`.  
  *Low • 3 SP • To Do*

### User Story 4.4: Интеграция LLM для модерации
* **Описание:** Автоматическая проверка контента через LLM.
* **Критерии приёмки:**
  * LLM-модуль классифицирует контент.
  * В случае сомнений — фоллбэк на ручную модерацию.

#### Tasks
- **Task 4.4.1:** Исследовать доступные LLM.  
  *Medium • 3 SP • To Do*  
- **Task 4.4.2:** Реализовать адаптер в `gateways/moderation.py`.  
  *High • 5 SP • To Do*  
- **Task 4.4.3:** Логика фоллбэка на ручную модерацию.  
  *Medium • 3 SP • To Do*

---

## Epic 5: Администрирование и технические улучшения

### User Story 5.1: Панель администратора
* **Описание:** Расширенный дашборд для админа.
* **Критерии приёмки:**
  * Просмотр статистики и управление пользователями.

#### Tasks
- **Task 5.1.1:** UI-панель администратора.  
  *Medium • 8 SP • To Do*  
- **Task 5.1.2:** API-эндпоинты для администрирования.  
  *Medium • 5 SP • To Do*

### User Story 5.2: Оптимизация производительности API
* **Описание:** Улучшить скорость ответов и кешировать.
* **Критерии приёмки:**
  * Среднее время ответа < 200 мс.
  * Тестовая нагрузка стабильна при целевом трафике.

#### Tasks
- **Task 5.2.1:** Профилирование запросов.  
  *High • 3 SP • To Do*  
- **Task 5.2.2:** Оптимизировать SQL-запросы.  
  *High • 5 SP • In Progress*  
- **Task 5.2.3:** Внедрить Redis-кеш.  
  *Medium • 5 SP • To Do*

### User Story 5.3: Мониторинг и логирование
* **Описание:** Внедрить алёрты и централизованное логирование.
* **Критерии приёмки:**
  * Метрики и логи доступны в едином интерфейсе.
  * Настроены уведомления при критических ошибках.

#### Tasks
- **Task 5.3.1:** Выбрать инструмент мониторинга (Prometheus/Grafana).  
  *Medium • 3 SP • To Do*  
- **Task 5.3.2:** Настроить сбор метрик и алёрты.  
  *Medium • 5 SP • To Do*

---

## Дефекты и Исправления (Bug Fixes / Rework)

### Bug Fix 1: Некорректное отображение даты публикации
* **Ссылка:** User Story 3.1  
* **Причина:** Не учтена временная зона.  
* **Исправление:** Привести все даты к UTC + корректная локализация.  
*High • 2 SP • Done*

### Bug Fix 2: Ошибка загрузки файлов >2 MB
* **Ссылка:** User Story 4.1  
* **Причина:** Лимиты Nginx и FastAPI.  
* **Исправление:** Увеличить `client_max_body_size` и параметры FastAPI.  
*Medium • 3 SP • In Progress*

### Bug Fix 3: Теги со спецсимволами не сохраняются
* **Ссылка:** User Story 4.3  
* **Причина:** Отсутствует экранирование.  
* **Исправление:** Валидация и очистка тегов перед сохранением.  
*Low • 2 SP • To Do*

### Rework 1: Премодерация комментариев
* **Ссылка:** User Story 3.3  
* **Причина:** Спам в комментариях.  
* **Исправление:** Внедрить флоу модерации для комментариев.  
*Medium • 8 SP • To Do*

### Bug Fix 4: Удаление признания не удаляет связанные данные
* **Ссылка:** —  
* **Причина:** Нет каскадного удаления.  
* **Исправление:** Настроить `ON DELETE CASCADE` для FK.  
*Medium • 3 SP • To Do*

### Bug Fix 5: 404 при получении несуществующего опроса
* **Ссылка:** User Story 4.2  
* **Причина:** Нет обработки `None` в API.  
* **Исправление:** Добавить проверку и возвращать 404.  
*High • 2 SP • To Do*
